# Thay đổi state trong effect

> Việc cập nhật state từ bên trong useEffect không được khuyến khích, trừ 1 số tình huống cần thiết

```js
import { useState, useEffect } from "react";

function App() {
    const [count, setCount] = useState(0);

    useEffect(() => {
        setCount((previousCount) => previousCount + 1);
    });
}
```

Đoạn code trên sẽ chạy 1 vòng lặp vô hạn:

-   Khi component được render lần đầu tiên, useEffect được gọi
-   useEffect được gọi làm count tăng thêm 1
-   count tăng thêm 1 làm component render lại
-   Component render lại làm useEffect được gọi tiếp

# Tích hợp đồng hồ vào trang web

Tạo 1 state là date và khởi tạo giá trị ban đầu là 1 `new Date()`, sau đó chuyển sang giá trị `toLocaleTimeString()` để hiển thị

```js
import { useState, useEffect } from "react";

function Clock() {
    const [date, setDate] = useState(new Date());

    return <h2>{date.toLocaleTimeString()}</h2>;
}
```

Sử dụng setInterval() để lặp lại việc làm mới date sau mỗi 1000ms, sau đó dùng useEffect để thay đổi state

```js
useEffect(() => {
    setInterval(() => {
        setDate(new Date());
    }, 1_000);
}, []);
```

Đặt interValId cho setInterval để dọn dẹp hiệu ứng sau mỗi lần gọi useEffect

```js
let date = new Date();
console.log(date.toLocaleTimeString());
const intervalId = setInterval(() => {
    date = new Date();
    console.log(date.toLocaleTimeString());
}, 1_000);

clearInterval(intervalId);
```

# Sử dụng flag để kiểm soát việc chjay hiệu ứng

Xét ví dụ về `Stopwatch`

```js
function Stopwatch() {
    const [counter, setCounter] = useState(0);

    useEffect(() => {
        let timerId = setTimeout(() => {
            setCounter((prevCounter) => prevCounter + 1);
        }, 1_000);
        return () => {
            clearTimeout(timerId);
        };
    });

    function handleButtonClick() {}

    return (
        <>
            <h2>{counter}</h2>
            <button onClick={handleButtonClick}>Start / Pause</button>
        </>
    );
}
```

Để nút Start / Pause hoạt động, cần 1 biến state có kiểu dữ liệu boolean

```js
const [running, setRunning] = useState(false);
```

Đóng gói code bên trong useEffect để quyết định khi nào sẽ chạy setInterval

```js
useEffect(() => {
    if (running) {
        let timerId = setTimeout(() => {
            setCounter((prevCounter) => prevCounter + 1);
        }, 1_000);
        return () => {
            clearTimeout(timerId);
        };
    }
});
```

Thay đổi giá trị boolean của running bằng hàm handleButtonClick

```js
function handleButtonClick() {
    setRunning((prevValue) => !prevValue);
}
```

```js
import { useState, useEffect } from "react";

function Stopwatch() {
    const [counter, setCounter] = useState(0);
    const [running, setRunning] = useState(false);

    useEffect(() => {
        if (running) {
            let timerId = setTimeout(() => {
                setCounter((prevCounter) => prevCounter + 1);
            }, 1_000);
            return () => {
                clearTimeout(timerId);
            };
        }
    });

    function handleStopClick() {
        setCounter(0);
        setRunning(false);
    }

    return (
        <>
            <h2>{counter}</h2>
            <button onClick={() => setRunning((prevRunning) => !prevRunning)}>
                Start / Pause
            </button>
            <button onClick={handleStopClick}>Stop</button>
        </>
    );
}
```
